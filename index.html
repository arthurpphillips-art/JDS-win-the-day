<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Win the Day</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    (function() {
      if (localStorage.getItem('wtd_auth') === 'ok') return;
      var pwd = prompt('Password:');
      if (pwd !== 'jds2025') {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#f472b6;font-family:DM Sans,sans-serif;">Access denied.</div>';
        throw new Error('denied');
      }
      localStorage.setItem('wtd_auth', 'ok');
    })();
  </script>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #1a1a24;
      --border: #2a2a3a;
      --text: #f0f0f5;
      --muted: #8888a0;
      --dim: #555566;
      --green: #34d399;
      --rose: #f472b6;
      --amber: #fbbf24;
      --blue: #4d7cff;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; padding:32px; }
    .page { max-width:900px; margin:0 auto; }

    h1 { font-size:20px; font-weight:600; margin-bottom:24px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size:12px; color:var(--muted); font-weight:400; }

    .controls { display:flex; gap:12px; align-items:flex-end; margin-bottom:24px; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .field label { font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--dim); }
    input { padding:7px 10px; background:var(--card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:inherit; font-size:13px; outline:none; }
    input:focus { border-color:var(--blue); }
    input[type="number"] { width:90px; font-family:'JetBrains Mono',monospace; font-size:12px; }

    .section-label { font-size:11px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); margin-bottom:8px; }

    table { width:100%; border-collapse:collapse; }
    th { text-align:left; padding:8px 10px; font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--dim); border-bottom:1px solid var(--border); }
    th.r { text-align:right; }
    th.c { text-align:center; }
    td { padding:8px 10px; font-family:'JetBrains Mono',monospace; font-size:13px; border-bottom:1px solid rgba(42,42,58,.4); }
    td.name { font-family:'DM Sans',sans-serif; font-weight:500; }
    td.r { text-align:right; }
    td.c { text-align:center; }
    tr:last-child td { border-bottom:none; }

    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }

    .win { color:var(--green); }
    .lose { color:var(--rose); }
    .even { color:var(--amber); }

    .bar { width:100%; height:5px; background:rgba(255,255,255,.06); border-radius:3px; overflow:hidden; }
    .bar-fill { height:100%; border-radius:3px; transition:width .4s; }
    .bar-fill.g { background:var(--green); }
    .bar-fill.a { background:var(--amber); }
    .bar-fill.r { background:var(--rose); }

    .toggle { cursor:pointer; font-size:12px; color:var(--dim); margin-bottom:12px; user-select:none; }
    .toggle:hover { color:var(--muted); }
    .collapsible { display:none; }
    .collapsible.open { display:block; }

    .targets-grid {
      display:grid;
      grid-template-columns: auto 1fr 1fr;
      gap: 6px 12px;
      align-items:center;
      margin-bottom:12px;
    }
    .targets-grid .tg-label {
      font-size:12px;
      color:var(--muted);
      font-weight:500;
    }
    .targets-grid .tg-header {
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--dim);
      padding-bottom:4px;
    }
    .targets-grid input[type="number"] { width:100%; }

    #status { font-size:11px; color:var(--dim); margin-bottom:16px; }

    /* 3-Day Forecast styles */
    .forecast-header {
      font-size:16px;
      font-weight:600;
      margin-bottom:16px;
      margin-top:32px;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--text);
    }
    .forecast-header .badge {
      font-size:10px;
      font-weight:500;
      background:rgba(77,124,255,.15);
      color:var(--blue);
      padding:3px 8px;
      border-radius:6px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .forecast-note {
      font-size:11px;
      color:var(--dim);
      margin-bottom:16px;
      line-height:1.5;
    }

    /* Forecast table with day columns */
    .forecast-table th.day-col {
      text-align:center;
      min-width:120px;
    }
    .forecast-table td.day-cell {
      text-align:center;
      font-size:12px;
      line-height:1.5;
    }
    .forecast-table td.day-cell .val {
      font-family:'JetBrains Mono',monospace;
      font-size:13px;
    }
    .forecast-table td.day-cell .vs {
      font-size:10px;
      color:var(--dim);
    }
    .forecast-table td.day-cell .wl {
      font-size:11px;
      font-weight:600;
    }
    .forecast-table td.dept-name {
      font-family:'DM Sans',sans-serif;
      font-weight:500;
      font-size:13px;
    }
    .forecast-table td.dept-name .target-hint {
      display:block;
      font-size:10px;
      color:var(--dim);
      font-weight:400;
    }

    .spinner-sm {
      display:inline-block;
      width:14px; height:14px;
      border:2px solid rgba(255,255,255,.1);
      border-top-color:var(--blue);
      border-radius:50%;
      animation:spin .6s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Divider */
    .section-divider {
      border:none;
      border-top:1px solid var(--border);
      margin:32px 0;
    }

    /* Tab controls */
    .tab-bar {
      display:flex;
      gap:4px;
      margin-bottom:24px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:4px;
    }
    .tab-btn {
      flex:1;
      padding:8px 16px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-family:'DM Sans',sans-serif;
      font-size:13px;
      font-weight:500;
      border-radius:7px;
      cursor:pointer;
      transition:all .2s;
    }
    .tab-btn:hover { color:var(--text); }
    .tab-btn.active {
      background:rgba(77,124,255,.12);
      color:var(--blue);
    }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    /* Separator row */
    .sep-row td { border-top:1px solid var(--border); }
  </style>
</head>
<body>
<div class="page">
  <h1>Win the Day <span>Daily Scorecard</span></h1>

  <!-- Tab Navigation -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('forecast')">üìÖ 3-Day Forecast</button>
    <button class="tab-btn" onclick="switchTab('daily')">üèÜ Daily Scorecard</button>
  </div>

  <!-- ===================== 3-DAY FORECAST TAB ===================== -->
  <div class="tab-panel active" id="tab-forecast">
    <div class="forecast-header">üìÖ 3-Day Forecast <span class="badge">Live from ServiceTitan</span></div>
    <div class="forecast-note" id="forecastStatus">Loading scheduled jobs from ServiceTitan...</div>

    <!-- Jobs Forecast -->
    <div class="card">
      <div class="section-label">Jobs Scheduled</div>
      <table class="forecast-table">
        <thead>
          <tr>
            <th style="width:140px;">Department</th>
            <th class="day-col" id="fjHead1">Day 1</th>
            <th class="day-col" id="fjHead2">Day 2</th>
            <th class="day-col" id="fjHead3">Day 3</th>
          </tr>
        </thead>
        <tbody id="forecastJobsBody">
          <tr><td colspan="4" style="text-align:center;color:var(--dim);padding:16px;"><div class="spinner-sm"></div> Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Revenue Forecast -->
    <div class="card">
      <div class="section-label">Revenue (Pre-Tax)</div>
      <table class="forecast-table">
        <thead>
          <tr>
            <th style="width:140px;">Department</th>
            <th class="day-col" id="frHead1">Day 1</th>
            <th class="day-col" id="frHead2">Day 2</th>
            <th class="day-col" id="frHead3">Day 3</th>
          </tr>
        </thead>
        <tbody id="forecastRevBody">
          <tr><td colspan="4" style="text-align:center;color:var(--dim);padding:16px;"><div class="spinner-sm"></div> Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Other Goals Forecast -->
    <div class="card">
      <div class="section-label">Other Goals <span style="font-size:10px;color:var(--dim);text-transform:none;letter-spacing:0;">‚Äî Today only</span></div>
      <table class="forecast-table">
        <thead>
          <tr>
            <th style="width:140px;">Goal</th>
            <th class="day-col" id="fgHead1">Day 1</th>
            <th class="day-col" id="fgHead2">Day 2</th>
            <th class="day-col" id="fgHead3">Day 3</th>
          </tr>
        </thead>
        <tbody id="forecastGoalsBody">
          <tr><td colspan="4" style="text-align:center;color:var(--dim);padding:16px;"><div class="spinner-sm"></div> Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===================== DAILY SCORECARD TAB ===================== -->
  <div class="tab-panel" id="tab-daily">
    <div class="controls">
      <div class="field">
        <label>Date</label>
        <input type="date" id="pickDate" onchange="render()">
      </div>
    </div>

    <!-- Targets Settings -->
    <div class="toggle" id="tgtToggle" onclick="togglePanel('tgt')">&#9656; Set Targets</div>
    <div class="collapsible" id="tgt">
      <div class="card" style="margin-bottom:16px;">
        <div class="section-label" style="margin-bottom:10px;">Daily Job Targets</div>
        <div class="targets-grid">
          <div class="tg-header"></div><div class="tg-header">Target</div><div></div>
          <div class="tg-label">Installs</div><input type="number" id="tJobIns" value="2.5" step="0.1" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Service</div><input type="number" id="tJobSvc" value="16" step="1" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Maintenance</div><input type="number" id="tJobMnt" value="7" step="1" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Ducts</div><input type="number" id="tJobDct" value="0.5" step="0.1" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Leads</div><input type="number" id="tJobLeads" value="4" step="1" onchange="saveTargets(); render()"><div></div>
        </div>

        <div class="section-label" style="margin-bottom:10px;">Daily Revenue Targets ($)</div>
        <div class="targets-grid">
          <div class="tg-header"></div><div class="tg-header">Target</div><div></div>
          <div class="tg-label">Installs</div><input type="number" id="tRevIns" value="16358" step="100" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Service</div><input type="number" id="tRevSvc" value="3729" step="100" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Maintenance</div><input type="number" id="tRevMnt" value="917" step="100" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Ducts</div><input type="number" id="tRevDct" value="418" step="100" onchange="saveTargets(); render()"><div></div>
        </div>

        <div class="section-label" style="margin-bottom:10px;">Other Goal Targets</div>
        <div class="targets-grid">
          <div class="tg-header"></div><div class="tg-header">Target</div><div></div>
          <div class="tg-label">Google Reviews</div><input type="number" id="tReviews" value="3" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Plan Sales</div><input type="number" id="tPlans" value="3" onchange="saveTargets(); render()"><div></div>
          <div class="tg-label">Booking Rate (%)</div><input type="number" id="tBookingRate" value="75" onchange="saveTargets(); render()"><div></div>
        </div>
      </div>
    </div>

    <div id="status">Loading...</div>
    <div id="content"></div>
  </div>
</div>

<script>
var SB_URL = 'https://yquqqfqtrozpcxwkvvmf.supabase.co';
var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxdXFxZnF0cm96cGN4d2t2dm1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODMzNDgsImV4cCI6MjA4NDE1OTM0OH0.VjsmiyU5EXCrFXIzMsnO-3q1zkBekqhoErOyvbKhM8s';

var allJobs = [];
var forecastBookingData = null;

// ========================================
// JOB TYPE - DEPARTMENT MAPPING
// ========================================
var JOB_TYPE_MAP = {
  'Install HVAC': 'Install',
  'Service - Old JT': 'Service',
  'Diagnostic or Call Out - Residential HVAC': 'Service',
  'Diagnostic or Call Out - Commercial HVAC': 'Service',
  'Repair': 'Service',
  'Workmanship Callback': 'Service',
  'Warranty Repair': 'Service',
  'Service Workmanship Callback': 'Service',
  'Commercial Maintenance': 'Service',
  'Imported Default JobType': 'Service',
  'Residential Maintenance 1 Piece': 'Maintenance',
  'Residential Maintenance 2 piece': 'Maintenance',
  'Residential Maintanance 2 Piece': 'Maintenance',
  'Residential Membership Plan Visit': 'Maintenance',
  'Residential Duct Cleaning': 'Ducts'
};

function classifyJob(j) {
  var jt = (j.job_type || '').trim();
  return JOB_TYPE_MAP[jt] || null;
}

function dateOf(val) {
  if (!val) return '';
  return String(val).substring(0, 10);
}

function localToday() {
  var d = new Date();
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, '0');
  var day = String(d.getDate()).padStart(2, '0');
  return y + '-' + m + '-' + day;
}

// ========================================
// TARGETS
// ========================================
var TARGET_KEYS = ['tJobIns','tJobSvc','tJobMnt','tJobDct','tJobLeads','tRevIns','tRevSvc','tRevMnt','tRevDct','tReviews','tPlans','tBookingRate'];

function saveTargets() {
  var data = {};
  TARGET_KEYS.forEach(function(k) { data[k] = document.getElementById(k).value; });
  try { localStorage.setItem('wtd_targets', JSON.stringify(data)); } catch(e) {}
}

function loadTargets() {
  try {
    var saved = JSON.parse(localStorage.getItem('wtd_targets'));
    if (saved) {
      TARGET_KEYS.forEach(function(k) {
        if (saved[k] !== undefined) document.getElementById(k).value = saved[k];
      });
    }
  } catch(e) {}
}

function togglePanel(id) {
  var el = document.getElementById(id);
  var tog = document.getElementById(id + 'Toggle');
  var open = el.classList.toggle('open');
  tog.innerHTML = (open ? '&#9662;' : '&#9656;') + ' Set Targets';
}

function getTargets() {
  return {
    jobs: {
      Install: parseFloat(document.getElementById('tJobIns').value) || 0,
      Service: parseFloat(document.getElementById('tJobSvc').value) || 0,
      Maintenance: parseFloat(document.getElementById('tJobMnt').value) || 0,
      Ducts: parseFloat(document.getElementById('tJobDct').value) || 0
    },
    jobLeads: parseFloat(document.getElementById('tJobLeads').value) || 0,
    rev: {
      Install: parseFloat(document.getElementById('tRevIns').value) || 0,
      Service: parseFloat(document.getElementById('tRevSvc').value) || 0,
      Maintenance: parseFloat(document.getElementById('tRevMnt').value) || 0,
      Ducts: parseFloat(document.getElementById('tRevDct').value) || 0
    },
    reviews: parseFloat(document.getElementById('tReviews').value) || 0,
    plans: parseFloat(document.getElementById('tPlans').value) || 0,
    bookingRate: parseFloat(document.getElementById('tBookingRate').value) || 75
  };
}

async function sbFetch(table, params) {
  params = params || {};
  var url = new URL(SB_URL + '/rest/v1/' + table);
  Object.keys(params).forEach(function(k) { url.searchParams.append(k, params[k]); });
  var r = await fetch(url, { headers: { apikey: SB_KEY, Authorization: 'Bearer ' + SB_KEY } });
  return r.json();
}

function n(v) { var x = parseFloat(v); return isNaN(x) ? 0 : x; }
function fmt(v) { return '$' + Math.round(v).toLocaleString('en-CA'); }

function wl(val, money) {
  var cls = val > 0 ? 'win' : val < 0 ? 'lose' : 'even';
  var sign = val > 0 ? '+' : '';
  var txt = money ? fmt(val) : (Math.round(val * 10) / 10);
  return '<span class="' + cls + '">' + sign + txt + '</span>';
}

function bar(actual, target) {
  if (!target) return '';
  var pct = Math.min(actual / target * 100, 100);
  var c = pct >= 100 ? 'g' : pct >= 70 ? 'a' : 'r';
  return '<div class="bar"><div class="bar-fill ' + c + '" style="width:' + pct + '%"></div></div>';
}

// ========================================
// TAB SWITCHING
// ========================================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(function(btn, i) {
    btn.classList.toggle('active', (tab === 'forecast' && i === 0) || (tab === 'daily' && i === 1));
  });
  document.getElementById('tab-forecast').classList.toggle('active', tab === 'forecast');
  document.getElementById('tab-daily').classList.toggle('active', tab === 'daily');
}

// ========================================
// 3-DAY FORECAST
// ========================================
async function loadForecast() {
  try {
    var response = await fetch('/api/upcoming');
    if (!response.ok) throw new Error('API returned ' + response.status);
    var data = await response.json();
    if (!data.success) throw new Error(data.error || 'Unknown error');
    forecastBookingData = data.bookingData || null;
    renderForecast(data.days);
  } catch(e) {
    document.getElementById('forecastStatus').textContent = 'Failed to load forecast: ' + e.message;
    document.getElementById('forecastJobsBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--rose);padding:16px;">Error loading data</td></tr>';
    document.getElementById('forecastRevBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--rose);padding:16px;">Error loading data</td></tr>';
    document.getElementById('forecastGoalsBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--rose);padding:16px;">Error loading data</td></tr>';
  }
}

function renderForecast(days) {
  var t = getTargets();
  var deptNames = ['Install', 'Service', 'Maintenance', 'Ducts'];

  // Set column headers
  days.forEach(function(day, i) {
    document.getElementById('fjHead' + (i+1)).textContent = day.label;
    document.getElementById('frHead' + (i+1)).textContent = day.label;
    document.getElementById('fgHead' + (i+1)).textContent = day.label;
  });

  // ==================
  // JOBS TABLE
  // ==================
  var jobsHtml = '';
  deptNames.forEach(function(dept) {
    jobsHtml += '<tr><td class="dept-name">' + dept + '<span class="target-hint">Target: ' + t.jobs[dept] + '</span></td>';
    days.forEach(function(day) {
      var actual = day.departments[dept].jobs;
      var target = t.jobs[dept];
      var diff = actual - target;
      var cls = diff > 0 ? 'win' : diff < 0 ? 'lose' : 'even';
      jobsHtml += '<td class="day-cell"><div class="val">' + actual + '</div>' + bar(actual, target) + '<div class="wl ' + cls + '">' + (diff > 0 ? '+' : '') + (Math.round(diff*10)/10) + '</div></td>';
    });
    jobsHtml += '</tr>';
  });
  // Leads row below Ducts
  var leadsTarget = t.jobLeads;
  jobsHtml += '<tr><td class="dept-name">Leads<span class="target-hint">Target: ' + leadsTarget + '</span></td>';
  days.forEach(function(day) {
    var actual = day.leadsRun;
    var diff = actual - leadsTarget;
    var cls = diff > 0 ? 'win' : diff < 0 ? 'lose' : 'even';
    jobsHtml += '<td class="day-cell"><div class="val">' + actual + '</div>' + bar(actual, leadsTarget) + '<div class="wl ' + cls + '">' + (diff > 0 ? '+' : '') + (Math.round(diff*10)/10) + '</div></td>';
  });
  jobsHtml += '</tr>';
  // Total row (departments only, no leads)
  jobsHtml += '<tr class="sep-row"><td class="dept-name" style="color:var(--muted);">Total</td>';
  days.forEach(function(day) {
    jobsHtml += '<td class="day-cell"><div class="val" style="color:var(--muted);">' + day.totalJobs + '</div></td>';
  });
  jobsHtml += '</tr>';
  document.getElementById('forecastJobsBody').innerHTML = jobsHtml;

  // ==================
  // REVENUE TABLE
  // ==================
  var revHtml = '';
  deptNames.forEach(function(dept) {
    revHtml += '<tr><td class="dept-name">' + dept + '<span class="target-hint">Target: ' + fmt(t.rev[dept]) + '</span></td>';
    days.forEach(function(day) {
      var actual = day.departments[dept].rev;
      var target = t.rev[dept];
      var diff = actual - target;
      var cls = diff > 0 ? 'win' : diff < 0 ? 'lose' : 'even';
      revHtml += '<td class="day-cell"><div class="val">' + fmt(actual) + '</div>' + bar(actual, target) + '<div class="wl ' + cls + '">' + (diff > 0 ? '+' : '') + fmt(diff) + '</div></td>';
    });
    revHtml += '</tr>';
  });
  // Total row
  revHtml += '<tr class="sep-row"><td class="dept-name" style="color:var(--muted);">Total</td>';
  days.forEach(function(day) {
    revHtml += '<td class="day-cell"><div class="val" style="color:var(--muted);">' + fmt(day.totalRevenue) + '</div></td>';
  });
  revHtml += '</tr>';
  // Revenue Sold row (leads revenue, separate from total)
  revHtml += '<tr><td class="dept-name" style="color:var(--amber);">Revenue Sold<span class="target-hint" style="color:var(--dim);">Not yet earned</span></td>';
  days.forEach(function(day) {
    revHtml += '<td class="day-cell"><div class="val" style="color:var(--amber);">' + fmt(day.leadsRevenue) + '</div></td>';
  });
  revHtml += '</tr>';
  document.getElementById('forecastRevBody').innerHTML = revHtml;

  // ==================
  // OTHER GOALS TABLE (today only)
  // ==================
  var goalsHtml = '';
  var goalRows = [
    { name: 'Google Reviews', key: 'reviews', getActual: function() { return null; } },
    { name: 'Plan Sales', key: 'plans', getActual: function(day) { return day.planSales; } },
    { name: 'Booking Rate', key: 'bookingRate', getActual: function() { return null; } }
  ];
  goalRows.forEach(function(goal) {
    var target = t[goal.key];
    goalsHtml += '<tr><td class="dept-name">' + goal.name + '<span class="target-hint">Target: ' + (goal.key === 'bookingRate' ? target + '%' : target) + '</span></td>';
    days.forEach(function(day) {
      if (!day.isToday) {
        goalsHtml += '<td class="day-cell"><div class="val" style="color:var(--dim);">‚Äî</div></td>';
        return;
      }
      if (goal.key === 'reviews') {
        goalsHtml += '<td class="day-cell"><div class="val" style="color:var(--dim);">‚Äî</div><div style="font-size:10px;color:var(--dim);">Manual</div></td>';
      } else if (goal.key === 'bookingRate') {
        if (forecastBookingData && forecastBookingData.bookingRate !== null) {
          var rate = forecastBookingData.bookingRate;
          var diff = rate - target;
          var cls = diff >= 0 ? 'win' : 'lose';
          goalsHtml += '<td class="day-cell"><div class="val">' + rate + '%</div>' + bar(rate, target) + '<div class="wl ' + cls + '">' + (diff >= 0 ? '+' : '') + diff + '%</div><div style="font-size:10px;color:var(--dim);">' + forecastBookingData.bookedCalls + '/' + forecastBookingData.inboundCalls + ' calls</div></td>';
        } else {
          goalsHtml += '<td class="day-cell"><div class="val" style="color:var(--dim);">‚Äî</div><div style="font-size:10px;color:var(--dim);">No data</div></td>';
        }
      } else {
        var actual = goal.getActual(day);
        var diff = actual - target;
        var cls = diff > 0 ? 'win' : diff < 0 ? 'lose' : 'even';
        goalsHtml += '<td class="day-cell"><div class="val">' + actual + '</div>' + bar(actual, target) + '<div class="wl ' + cls + '">' + (diff > 0 ? '+' : '') + (Math.round(diff*10)/10) + '</div></td>';
      }
    });
    goalsHtml += '</tr>';
  });
  document.getElementById('forecastGoalsBody').innerHTML = goalsHtml;

  // Update status
  var ts = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  var note = 'Showing scheduled appointments for ' + days.map(function(d) { return d.label; }).join(', ') + '. Updated at ' + ts + '.';
  var futureNote = days.some(function(d) { return !d.isToday; }) ? ' Future days show scheduled jobs ‚Äî revenue may update after completion.' : '';
  document.getElementById('forecastStatus').textContent = note + futureNote;
}

// ========================================
// DAILY SCORECARD (existing)
// ========================================
async function init() {
  loadTargets();
  document.getElementById('pickDate').value = localToday();

  // Load forecast in parallel
  loadForecast();

  try {
    allJobs = await sbFetch('completed_jobs_public', { order: 'completion_date.desc', limit: '10000', job_id: 'not.is.null' });
    var latestDate = allJobs.length > 0 ? allJobs[0].completion_date : 'none';
    document.getElementById('status').textContent = allJobs.length + ' jobs loaded | latest in data: ' + latestDate;
    render();
  } catch(e) {
    document.getElementById('status').textContent = 'Connection failed: ' + e.message;
  }
}

function render() {
  var date = document.getElementById('pickDate').value;
  if (!date || !allJobs.length) return;

  var t = getTargets();
  var deptNames = ['Install','Service','Maintenance','Ducts'];

  var todayJobs = allJobs.filter(function(j) { return dateOf(j.completion_date) === date; });
  var actuals = { Install: { rev: 0, jobs: 0 }, Service: { rev: 0, jobs: 0 }, Maintenance: { rev: 0, jobs: 0 }, Ducts: { rev: 0, jobs: 0 } };
  var excluded = 0;

  todayJobs.forEach(function(j) {
    var dp = classifyJob(j);
    if (dp) {
      actuals[dp].rev += n(j.jobs_total_revenue);
      actuals[dp].jobs++;
    } else {
      excluded++;
    }
  });

  var planSales = todayJobs.filter(function(j) {
    var jt = (j.job_type || '').trim();
    return jt === 'Residential Membership Plan Visit';
  }).length;

  var leadsRun = todayJobs.filter(function(j) {
    var jt = (j.job_type || '').trim();
    return jt === 'Sales Visit' || jt === 'Sales Follow Up';
  }).length;

  var leadsRevenue = 0;
  todayJobs.forEach(function(j) {
    var jt = (j.job_type || '').trim();
    if (jt === 'Sales Visit' || jt === 'Sales Follow Up') {
      leadsRevenue += n(j.jobs_total_revenue);
    }
  });

  var html = '';

  // Jobs (with Leads row)
  html += '<div class="card"><div class="section-label">Jobs</div><table>';
  html += '<tr><th>Department</th><th class="r">Actual</th><th class="r">Target</th><th class="r">W/L</th><th style="width:80px"></th></tr>';
  deptNames.forEach(function(dp) {
    var a = actuals[dp].jobs;
    var tgt = t.jobs[dp];
    html += '<tr><td class="name">' + dp + '</td><td class="r">' + a + '</td><td class="r">' + tgt + '</td><td class="r">' + wl(a - tgt) + '</td><td>' + bar(a, tgt) + '</td></tr>';
  });
  // Leads row
  html += '<tr><td class="name">Leads</td><td class="r">' + leadsRun + '</td><td class="r">' + t.jobLeads + '</td><td class="r">' + wl(leadsRun - t.jobLeads) + '</td><td>' + bar(leadsRun, t.jobLeads) + '</td></tr>';
  html += '</table></div>';

  // Revenue (with Revenue Sold row)
  html += '<div class="card"><div class="section-label">Revenue</div><table>';
  html += '<tr><th>Department</th><th class="r">Actual</th><th class="r">Target</th><th class="r">W/L</th><th style="width:80px"></th></tr>';
  var totalActualRev = 0;
  var totalTargetRev = 0;
  deptNames.forEach(function(dp) {
    var a = actuals[dp].rev;
    var tgt = t.rev[dp];
    totalActualRev += a;
    totalTargetRev += tgt;
    html += '<tr><td class="name">' + dp + '</td><td class="r">' + fmt(a) + '</td><td class="r">' + fmt(tgt) + '</td><td class="r">' + wl(a - tgt, true) + '</td><td>' + bar(a, tgt) + '</td></tr>';
  });
  // Total row
  html += '<tr style="border-top:1px solid var(--border);"><td class="name" style="color:var(--muted);">Total</td><td class="r" style="color:var(--muted);">' + fmt(totalActualRev) + '</td><td class="r" style="color:var(--muted);">' + fmt(totalTargetRev) + '</td><td class="r">' + wl(totalActualRev - totalTargetRev, true) + '</td><td>' + bar(totalActualRev, totalTargetRev) + '</td></tr>';
  // Revenue Sold row
  html += '<tr><td class="name" style="color:#fbbf24;">Revenue Sold</td><td class="r" style="color:#fbbf24;">' + fmt(leadsRevenue) + '</td><td class="r" style="color:var(--dim);">‚Äî</td><td class="r" style="color:var(--dim);">‚Äî</td><td></td></tr>';
  html += '</table></div>';

  // Other Goals (Google Reviews, Plan Sales, Booking Rate)
  html += '<div class="card"><div class="section-label">Other Goals</div><table>';
  html += '<tr><th>Goal</th><th class="r">Actual</th><th class="r">Target</th><th class="r">W/L</th><th style="width:80px"></th></tr>';

  // Google Reviews
  html += '<tr><td class="name">Google Reviews</td><td class="r" style="color:var(--dim);">‚Äî</td><td class="r">' + t.reviews + '</td><td class="r" style="color:var(--dim);">Manual</td><td></td></tr>';

  // Plan Sales
  html += '<tr><td class="name">Plan Sales</td><td class="r">' + planSales + '</td><td class="r">' + t.plans + '</td><td class="r">' + wl(planSales - t.plans) + '</td><td>' + bar(planSales, t.plans) + '</td></tr>';

  // Booking Rate
  if (forecastBookingData && forecastBookingData.bookingRate !== null) {
    var br = forecastBookingData.bookingRate;
    var brTarget = t.bookingRate;
    var brDiff = br - brTarget;
    var brSign = brDiff >= 0 ? '+' : '';
    var brCls = brDiff >= 0 ? 'win' : 'lose';
    html += '<tr><td class="name">Booking Rate</td><td class="r">' + br + '%</td><td class="r">' + brTarget + '%</td><td class="r"><span class="' + brCls + '">' + brSign + brDiff + '%</span></td><td>' + bar(br, brTarget) + '</td></tr>';
  } else {
    html += '<tr><td class="name">Booking Rate</td><td class="r" style="color:var(--dim);">‚Äî</td><td class="r">' + t.bookingRate + '%</td><td class="r" style="color:var(--dim);">‚Äî</td><td></td></tr>';
  }

  html += '</table></div>';

  var counted = actuals.Install.jobs + actuals.Service.jobs + actuals.Maintenance.jobs + actuals.Ducts.jobs;
  var latestDate = allJobs.length > 0 ? allJobs[0].completion_date : 'none';
  document.getElementById('status').textContent = allJobs.length + ' jobs | latest: ' + latestDate + ' | ' + date + ': ' + todayJobs.length + ' total, ' + counted + ' counted, ' + excluded + ' excluded';

  document.getElementById('content').innerHTML = html;
}

init();
</script>
</body>
</html>
