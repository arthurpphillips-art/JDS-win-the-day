<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Win the Day</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    (function() {
      var pwd = prompt('Password:');
      if (pwd !== 'jds2025') {
        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#f472b6;font-family:DM Sans,sans-serif;">Access denied.</div>';
        throw new Error('denied');
      }
    })();
  </script>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #1a1a24;
      --border: #2a2a3a;
      --text: #f0f0f5;
      --muted: #8888a0;
      --dim: #555566;
      --green: #34d399;
      --rose: #f472b6;
      --amber: #fbbf24;
      --blue: #4d7cff;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; padding:32px; }
    .page { max-width:700px; margin:0 auto; }

    h1 { font-size:20px; font-weight:600; margin-bottom:24px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size:12px; color:var(--muted); font-weight:400; }

    .controls { display:flex; gap:12px; align-items:flex-end; margin-bottom:24px; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .field label { font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--dim); }
    input { padding:7px 10px; background:var(--card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:inherit; font-size:13px; outline:none; }
    input:focus { border-color:var(--blue); }
    input[type="number"] { width:90px; font-family:'JetBrains Mono',monospace; font-size:12px; }

    .section-label { font-size:11px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); margin-bottom:8px; }

    table { width:100%; border-collapse:collapse; }
    th { text-align:left; padding:8px 10px; font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:var(--dim); border-bottom:1px solid var(--border); }
    th.r { text-align:right; }
    td { padding:8px 10px; font-family:'JetBrains Mono',monospace; font-size:13px; border-bottom:1px solid rgba(42,42,58,.4); }
    td.name { font-family:'DM Sans',sans-serif; font-weight:500; }
    td.r { text-align:right; }
    tr:last-child td { border-bottom:none; }

    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }

    .win { color:var(--green); }
    .lose { color:var(--rose); }
    .even { color:var(--amber); }

    .bar { width:100%; height:5px; background:rgba(255,255,255,.06); border-radius:3px; overflow:hidden; }
    .bar-fill { height:100%; border-radius:3px; transition:width .4s; }
    .bar-fill.g { background:var(--green); }
    .bar-fill.a { background:var(--amber); }
    .bar-fill.r { background:var(--rose); }

    .toggle { cursor:pointer; font-size:12px; color:var(--dim); margin-bottom:12px; user-select:none; }
    .toggle:hover { color:var(--muted); }
    .collapsible { display:none; }
    .collapsible.open { display:block; }

    .targets-grid {
      display:grid;
      grid-template-columns: auto 1fr 1fr;
      gap: 6px 12px;
      align-items:center;
      margin-bottom:12px;
    }
    .targets-grid .tg-label {
      font-size:12px;
      color:var(--muted);
      font-weight:500;
    }
    .targets-grid .tg-header {
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--dim);
      padding-bottom:4px;
    }
    .targets-grid input[type="number"] { width:100%; }

    #status { font-size:11px; color:var(--dim); margin-bottom:16px; }
  </style>
</head>
<body>
<div class="page">
  <h1>Win the Day <span>Daily Scorecard</span></h1>

  <div class="controls">
    <div class="field">
      <label>Date</label>
      <input type="date" id="pickDate" onchange="render()">
    </div>
  </div>

  <!-- Targets Settings -->
  <div class="toggle" id="tgtToggle" onclick="togglePanel('tgt')">&#9656; Set Targets</div>
  <div class="collapsible" id="tgt">
    <div class="card" style="margin-bottom:16px;">
      <div class="section-label" style="margin-bottom:10px;">Daily Job Targets</div>
      <div class="targets-grid">
        <div class="tg-header"></div><div class="tg-header">Target</div><div></div>
        <div class="tg-label">Installs</div><input type="number" id="tJobIns" value="2.5" step="0.1" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Service</div><input type="number" id="tJobSvc" value="16" step="1" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Maintenance</div><input type="number" id="tJobMnt" value="7" step="1" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Ducts</div><input type="number" id="tJobDct" value="0.5" step="0.1" onchange="saveTargets(); render()"><div></div>
      </div>

      <div class="section-label" style="margin-bottom:10px;">Daily Revenue Targets ($)</div>
      <div class="targets-grid">
        <div class="tg-header"></div><div class="tg-header">Target</div><div></div>
        <div class="tg-label">Installs</div><input type="number" id="tRevIns" value="16358" step="100" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Service</div><input type="number" id="tRevSvc" value="3729" step="100" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Maintenance</div><input type="number" id="tRevMnt" value="917" step="100" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Ducts</div><input type="number" id="tRevDct" value="418" step="100" onchange="saveTargets(); render()"><div></div>
      </div>

      <div class="section-label" style="margin-bottom:10px;">Other Goal Targets</div>
      <div class="targets-grid">
        <div class="tg-header"></div><div class="tg-header">Target</div><div></div>
        <div class="tg-label">Google Reviews</div><input type="number" id="tReviews" value="3" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Plan Sales</div><input type="number" id="tPlans" value="3" onchange="saveTargets(); render()"><div></div>
        <div class="tg-label">Leads Run</div><input type="number" id="tLeads" value="4" onchange="saveTargets(); render()"><div></div>
      </div>
    </div>
  </div>

  <div id="status">Loading...</div>
  <div id="content"></div>
</div>

<script>
var SB_URL = 'https://yquqqfqtrozpcxwkvvmf.supabase.co';
var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxdXFxZnF0cm96cGN4d2t2dm1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODMzNDgsImV4cCI6MjA4NDE1OTM0OH0.VjsmiyU5EXCrFXIzMsnO-3q1zkBekqhoErOyvbKhM8s';

var allJobs = [];

// ========================================
// JOB TYPE → DEPARTMENT MAPPING
// Matches the Excel spreadsheet exactly.
// Job types not listed here are EXCLUDED from counts.
// ========================================
var JOB_TYPE_MAP = {
  // Install
  'Install HVAC': 'Install',

  // Service
  'Service - Old JT': 'Service',
  'Diagnostic or Call Out - Residential HVAC': 'Service',
  'Diagnostic or Call Out - Commercial HVAC': 'Service',
  'Repair': 'Service',
  'Workmanship Callback': 'Service',
  'Warranty Repair': 'Service',
  'Service Workmanship Callback': 'Service',
  'Commercial Maintenance': 'Service',
  'Imported Default JobType': 'Service',

  // Maintenance
  'Residential Maintenance 1 Piece': 'Maintenance',
  'Residential Maintenance 2 piece': 'Maintenance',
  'Residential Maintanance 2 Piece': 'Maintenance',
  'Residential Membership Plan Visit': 'Maintenance',

  // Ducts
  'Residential Duct Cleaning': 'Ducts'

  // EXCLUDED (no department):
  // 'Sales Visit'
  // 'Sales Follow Up'
  // 'Install Workmanship Callback'
  // 'Safety Inspection-IMP'
};

function classifyJob(j) {
  var jt = (j.job_type || '').trim();
  return JOB_TYPE_MAP[jt] || null; // null = excluded
}

// Persist targets in localStorage
var TARGET_KEYS = ['tJobIns','tJobSvc','tJobMnt','tJobDct','tRevIns','tRevSvc','tRevMnt','tRevDct','tReviews','tPlans','tLeads'];

function saveTargets() {
  var data = {};
  TARGET_KEYS.forEach(function(k) { data[k] = document.getElementById(k).value; });
  try { localStorage.setItem('wtd_targets', JSON.stringify(data)); } catch(e) {}
}

function loadTargets() {
  try {
    var saved = JSON.parse(localStorage.getItem('wtd_targets'));
    if (saved) {
      TARGET_KEYS.forEach(function(k) {
        if (saved[k] !== undefined) document.getElementById(k).value = saved[k];
      });
    }
  } catch(e) {}
}

function togglePanel(id) {
  var el = document.getElementById(id);
  var tog = document.getElementById(id + 'Toggle');
  var open = el.classList.toggle('open');
  tog.innerHTML = (open ? '&#9662;' : '&#9656;') + ' Set Targets';
}

function getTargets() {
  return {
    jobs: {
      Install: parseFloat(document.getElementById('tJobIns').value) || 0,
      Service: parseFloat(document.getElementById('tJobSvc').value) || 0,
      Maintenance: parseFloat(document.getElementById('tJobMnt').value) || 0,
      Ducts: parseFloat(document.getElementById('tJobDct').value) || 0
    },
    rev: {
      Install: parseFloat(document.getElementById('tRevIns').value) || 0,
      Service: parseFloat(document.getElementById('tRevSvc').value) || 0,
      Maintenance: parseFloat(document.getElementById('tRevMnt').value) || 0,
      Ducts: parseFloat(document.getElementById('tRevDct').value) || 0
    },
    reviews: parseFloat(document.getElementById('tReviews').value) || 0,
    plans: parseFloat(document.getElementById('tPlans').value) || 0,
    leads: parseFloat(document.getElementById('tLeads').value) || 0
  };
}

async function sbFetch(table, params) {
  params = params || {};
  var url = new URL(SB_URL + '/rest/v1/' + table);
  Object.keys(params).forEach(function(k) { url.searchParams.append(k, params[k]); });
  var r = await fetch(url, { headers: { apikey: SB_KEY, Authorization: 'Bearer ' + SB_KEY } });
  return r.json();
}

function n(v) { var x = parseFloat(v); return isNaN(x) ? 0 : x; }
function fmt(v) { return '$' + Math.round(v).toLocaleString('en-CA'); }

function wl(val, money) {
  var cls = val > 0 ? 'win' : val < 0 ? 'lose' : 'even';
  var sign = val > 0 ? '+' : '';
  var txt = money ? fmt(val) : (Math.round(val * 10) / 10);
  return '<span class="' + cls + '">' + sign + txt + '</span>';
}

function bar(actual, target) {
  if (!target) return '';
  var pct = Math.min(actual / target * 100, 100);
  var c = pct >= 100 ? 'g' : pct >= 70 ? 'a' : 'r';
  return '<div class="bar"><div class="bar-fill ' + c + '" style="width:' + pct + '%"></div></div>';
}

async function init() {
  loadTargets();
  document.getElementById('pickDate').value = new Date().toISOString().split('T')[0];

  try {
    allJobs = await sbFetch('completed_jobs_public', { order: 'completion_date.desc', limit: '10000', job_id: 'not.is.null' });
    document.getElementById('status').textContent = allJobs.length + ' jobs loaded';
    render();
  } catch(e) {
    document.getElementById('status').textContent = 'Connection failed';
  }
}

function render() {
  var date = document.getElementById('pickDate').value;
  if (!date || !allJobs.length) return;

  var t = getTargets();
  var deptNames = ['Install','Service','Maintenance','Ducts'];

  // Today's jobs — classify using job_type mapping (matching Excel)
  var todayJobs = allJobs.filter(function(j) { return j.completion_date === date; });
  var actuals = { Install: { rev: 0, jobs: 0 }, Service: { rev: 0, jobs: 0 }, Maintenance: { rev: 0, jobs: 0 }, Ducts: { rev: 0, jobs: 0 } };
  var excluded = 0;

  todayJobs.forEach(function(j) {
    var dp = classifyJob(j);
    if (dp) {
      actuals[dp].rev += n(j.jobs_total_revenue);
      actuals[dp].jobs++;
    } else {
      excluded++;
    }
  });

  // Goal actuals — counted from today's jobs by job_type name
  var planSales = todayJobs.filter(function(j) {
    var jt = (j.job_type || '').trim();
    return jt === 'Residential Membership Plan Visit';
  }).length;

  var leadsRun = todayJobs.filter(function(j) {
    var jt = (j.job_type || '').trim();
    return jt === 'Sales Visit' || jt === 'Sales Follow Up';
  }).length;

  var html = '';

  // Jobs
  html += '<div class="card"><div class="section-label">Jobs</div><table>';
  html += '<tr><th>Department</th><th class="r">Actual</th><th class="r">Target</th><th class="r">W/L</th><th style="width:80px"></th></tr>';
  deptNames.forEach(function(dp) {
    var a = actuals[dp].jobs;
    var tgt = t.jobs[dp];
    html += '<tr><td class="name">' + dp + '</td><td class="r">' + a + '</td><td class="r">' + tgt + '</td><td class="r">' + wl(a - tgt) + '</td><td>' + bar(a, tgt) + '</td></tr>';
  });
  html += '</table></div>';

  // Revenue
  html += '<div class="card"><div class="section-label">Revenue</div><table>';
  html += '<tr><th>Department</th><th class="r">Actual</th><th class="r">Target</th><th class="r">W/L</th><th style="width:80px"></th></tr>';
  deptNames.forEach(function(dp) {
    var a = actuals[dp].rev;
    var tgt = t.rev[dp];
    html += '<tr><td class="name">' + dp + '</td><td class="r">' + fmt(a) + '</td><td class="r">' + fmt(tgt) + '</td><td class="r">' + wl(a - tgt, true) + '</td><td>' + bar(a, tgt) + '</td></tr>';
  });
  html += '</table></div>';

  // Other Goals
  html += '<div class="card"><div class="section-label">Other Goals</div><table>';
  html += '<tr><th>Goal</th><th class="r">Actual</th><th class="r">Target</th><th class="r">W/L</th><th style="width:80px"></th></tr>';
  var goals = [
    { name: 'Google Reviews', a: 0, t: t.reviews },
    { name: 'Plan Sales', a: planSales, t: t.plans },
    { name: 'Leads Run', a: leadsRun, t: t.leads }
  ];
  goals.forEach(function(g) {
    html += '<tr><td class="name">' + g.name + '</td><td class="r">' + g.a + '</td><td class="r">' + g.t + '</td><td class="r">' + wl(g.a - g.t) + '</td><td>' + bar(g.a, g.t) + '</td></tr>';
  });
  html += '</table></div>';

  // Status line
  var counted = actuals.Install.jobs + actuals.Service.jobs + actuals.Maintenance.jobs + actuals.Ducts.jobs;
  document.getElementById('status').textContent = allJobs.length + ' jobs loaded | ' + date + ': ' + todayJobs.length + ' total, ' + counted + ' counted, ' + excluded + ' excluded';

  document.getElementById('content').innerHTML = html;
}

init();
</script>
</body>
</html>